// File content is too long to include here, but it would contain all the improvements
// I'll provide the specific changes needed in the cleanup logic